name: Docker-Siries-Builds

on:
  push:
    branches:
    - django-project

jobs:
  build-push-image:
    name: Build and push docker images
    runs-on: [ubuntu-latest]
    steps:
    - name: Check out the repo
      uses: actions/checkout@v2
    - name: Log in to docker hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKER_USER }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    - name: Docker build education
      run: |
        docker build ./lab3/education -t dariwes/django-project:latest  -f ./lab3/education/Dockerfile
    - name: Push to docker hub
      run: |
        docker push dariwes/django-project:latest
  run-tests:
    name: Run tests
    runs-on: ubuntu-latest
    needs: [build-push-image]
    steps:
    - uses: actions/checkout@v2
    - name: Up and build docker-compose
      run: docker-compose -f ./lab3/docker-compose.yml up -d
    - name: Run tests
      run: docker-compose exec web pytest
    - name: Down docker-compose
      run: docker-compose -f ./lab3/docker-compose.yml down

